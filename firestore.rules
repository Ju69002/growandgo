
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BUSINESS PILOT SECURITY MODEL
     * 
     * Core Philosophy:
     * This ruleset implements a multi-tenant architecture where data is segregated by Company. 
     * Authorization is centered around the User's profile, which links them to a specific 
     * Company and assigns a Role (super_admin, admin, employee).
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Fetches the user's document to determine their permissions
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Checks if the authenticated user belongs to the specified company
    function belongsToCompany(companyId) {
      return isSignedIn() && getUserData().companyId == companyId;
    }

    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('admin') || hasRole('super_admin');
    }

    // --- COLLECTION RULES ---

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    match /companies/{companyId} {
      // Allow get for any signed-in user if it's the default company (for theme injection)
      // or if they explicitly belong to it.
      allow get: if isSignedIn() && (companyId == 'default-company' || belongsToCompany(companyId));
      allow list: if false;
      allow create: if isAdmin();
      allow update: if belongsToCompany(companyId) && isAdmin();
      allow delete: if belongsToCompany(companyId) && hasRole('super_admin');
    }

    match /companies/{companyId}/categories/{categoryId} {
      allow get: if belongsToCompany(companyId) && (isAdmin() || resource.data.visibleToEmployees == true);
      allow list: if belongsToCompany(companyId); 
      allow create: if belongsToCompany(companyId) && isAdmin() && request.resource.data.companyId == companyId;
      allow update: if belongsToCompany(companyId) && isAdmin();
      allow delete: if belongsToCompany(companyId) && isAdmin();
    }

    match /companies/{companyId}/documents/{documentId} {
      allow get: if belongsToCompany(companyId) && (
                    isAdmin() || 
                    (resource.data.categoryId != 'finance' && resource.data.categoryId != 'rh')
                  );
      allow list: if belongsToCompany(companyId);
      allow create: if belongsToCompany(companyId);
      allow update: if belongsToCompany(companyId) && (
                      isAdmin() || 
                      (resource.data.categoryId != 'finance' && resource.data.categoryId != 'rh')
                    );
      allow delete: if belongsToCompany(companyId) && isAdmin();
    }

    match /companies/{companyId}/events/{eventId} {
      allow read, write: if belongsToCompany(companyId);
    }
  }
}

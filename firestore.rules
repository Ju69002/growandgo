
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BUSINESS PILOT SECURITY RULES
     * 
     * Roles:
     * - super_admin: Accès total à tout.
     * - admin (Patron): Gère uniquement les données de SA société.
     * - employee: Lecture seule des dossiers visibles de SA société.
     */

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      let path = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(path) ? get(path).data : null;
    }

    function isSuperAdmin() {
      let data = getUserData();
      return isSignedIn() && data != null && data.role == 'super_admin';
    }

    function isPatron(companyId) {
      let data = getUserData();
      return isSignedIn() && data != null && data.companyId == companyId && data.role == 'admin';
    }

    function isEmployee(companyId) {
      let data = getUserData();
      return isSignedIn() && data != null && data.companyId == companyId && data.role == 'employee';
    }

    match /users/{userId} {
      // Permission list: true est nécessaire pour permettre au login de trouver l'email via l'ID
      allow get: if isSignedIn();
      allow list: if true; 
      allow create: if true; // Permettre l'inscription initiale
      allow update: if isSuperAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow delete: if isSuperAdmin();
    }

    match /companies/{companyId} {
      allow get: if isSignedIn(); 
      allow list: if isSuperAdmin();
      allow write: if isSuperAdmin();
    }

    match /companies/{companyId}/categories/{categoryId} {
      allow read: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow write: if isSuperAdmin() || isPatron(companyId);
    }

    match /companies/{companyId}/documents/{documentId} {
      allow read: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow write: if isSignedIn() && (isSuperAdmin() || isPatron(companyId));
    }

    match /companies/{companyId}/events/{eventId} {
      allow read: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow write: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
    }
  }
}

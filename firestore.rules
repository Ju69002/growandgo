
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BUSINESS PILOT SECURITY RULES
     * 
     * Roles:
     * - super_admin (JSecchi): Can manage everything and grant modification rights.
     * - admin (Patron): Can manage visibility and modify categories IF isCategoryModifier is true.
     * - employee: Read-only access to visible categories.
     */

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      let path = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(path) ? get(path).data : null;
    }

    function isSuperAdmin() {
      let data = getUserData();
      return isSignedIn() && data != null && data.role == 'super_admin';
    }

    function isPatron(companyId) {
      let data = getUserData();
      return isSignedIn() && data != null && data.companyId == companyId && data.role == 'admin';
    }

    function isEmployee(companyId) {
      let data = getUserData();
      return isSignedIn() && data != null && data.companyId == companyId && data.role == 'employee';
    }

    function canModifyCategories(companyId) {
      let data = getUserData();
      return isSuperAdmin() || (isPatron(companyId) && data.isCategoryModifier == true);
    }

    match /users/{userId} {
      allow get: if isSignedIn() && (request.auth.uid == userId || isSuperAdmin());
      allow list: if isSuperAdmin();
      allow create: if isSignedIn();
      allow update: if isSuperAdmin() || (request.auth.uid == userId && request.resource.data.role == resource.data.role && request.resource.data.isCategoryModifier == resource.data.isCategoryModifier);
      allow delete: if isSuperAdmin();
    }

    match /companies/{companyId} {
      allow get: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow list: if isSuperAdmin();
      allow write: if isSuperAdmin();
    }

    match /companies/{companyId}/categories/{categoryId} {
      allow list: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow get: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow create: if canModifyCategories(companyId);
      allow update: if canModifyCategories(companyId) || (isPatron(companyId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['visibleToEmployees', 'badgeCount']));
      allow delete: if canModifyCategories(companyId);
    }

    match /companies/{companyId}/documents/{documentId} {
      allow read: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow write: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
    }

    match /companies/{companyId}/events/{eventId} {
      allow read: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
      allow write: if isSignedIn() && (isSuperAdmin() || (getUserData() != null && getUserData().companyId == companyId));
    }
  }
}
